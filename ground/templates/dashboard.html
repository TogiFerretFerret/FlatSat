<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Artemis Ground Station</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root { --bg-color: #0d0d0d; --text-main: #00ff41; --border: #333; }
        body { background: var(--bg-color); color: var(--text-main); font-family: 'Courier New', monospace; padding: 10px; display: flex; flex-direction: column; height: 100vh; margin: 0; box-sizing: border-box; }
        .grid { display: grid; grid-template-columns: 1fr 1.8fr 1fr; grid-template-rows: 1fr auto; gap: 10px; flex-grow: 1; min-height: 0; }
        .panel { background: #141414; border: 1px solid var(--border); padding: 8px; overflow-y: auto; display: flex; flex-direction: column; }
        .box-val { background: #222; border: 1px solid #333; padding: 2px; text-align: center; }
        .box-num { font-weight: bold; font-size: 1.1em; color: #fff; }
        .box-lbl { font-size: 0.7em; color: #888; display: block; }
        .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 4px; margin-bottom: 8px; }
        .btn { background: #222; color: #fff; border: 1px solid #444; padding: 10px; cursor: pointer; font-weight: bold; width: 100%; margin-top: 5px; }
        .btn:hover { background: #333; }
        .btn-green { background: #004400; border-color: #00ff41; }
        .btn-red { background: #440000; border-color: #ff0000; }
        .btn-blue { background: #000044; border-color: #0088ff; }
        img.video { width: 100%; height: 100%; object-fit: contain; background: #000; }
        .gallery { height: 100px; display: flex; gap: 5px; overflow-x: auto; background: #111; padding: 5px; grid-column: 1 / -1; }
        .thumb { height: 100%; border: 1px solid #444; cursor: pointer; }
    </style>
</head>
<body>
    <div style="display:flex; justify-content:space-between; margin-bottom:10px; border-bottom:2px solid #00ff41;">
        <h2>ARTEMIS COMMAND</h2>
        <h2 id="status">CONNECTING...</h2>
    </div>

    <div class="grid">
        <!-- LEFT -->
        <div class="panel">
            <span class="box-lbl">ACCEL</span>
            <div class="grid-3">
                <div class="box-val"><span id="ax">0.0</span></div>
                <div class="box-val"><span id="ay">0.0</span></div>
                <div class="box-val"><span id="az">0.0</span></div>
            </div>
            <span class="box-lbl">GYRO</span>
            <div class="grid-3">
                <div class="box-val"><span id="gx">0.0</span></div>
                <div class="box-val"><span id="gy">0.0</span></div>
                <div class="box-val"><span id="gz">0.0</span></div>
            </div>
            <span class="box-lbl">MAG</span>
            <div class="grid-3">
                <div class="box-val"><span id="mx">0.0</span></div>
                <div class="box-val"><span id="my">0.0</span></div>
                <div class="box-val"><span id="mz">0.0</span></div>
            </div>
        </div>

        <!-- CENTER -->
        <div class="panel" style="padding:0;">
            <img id="video" class="video" src="{{ video_url }}">
            <button class="btn btn-green" onclick="snap()">SNAP (4.6K)</button>
        </div>

        <!-- RIGHT -->
        <div class="panel">
            <span class="box-lbl">OFFSET (Meters)</span>
            <div class="grid-3">
                <div class="box-val"><span id="off-x">0.00</span></div>
                <div class="box-val"><span id="off-y">0.00</span></div>
                <div class="box-val"><span id="off-z">0.00</span></div>
            </div>
            
            <div id="train-status" style="text-align:center; margin-bottom:5px; font-weight:bold; color:#888;">READY</div>
            
            <div style="display:flex; gap:5px; margin-bottom: 5px;">
                <button class="btn btn-blue" onclick="track('calibrate_start')">TRAIN START</button>
                <button class="btn btn-blue" onclick="track('calibrate_stop')">TRAIN STOP</button>
            </div>
            <div style="display:flex; gap:5px;">
                <button class="btn btn-green" onclick="track('start')">START TRACK</button>
                <button class="btn btn-red" onclick="track('stop')">STOP TRACK</button>
            </div>

            <div style="margin-top:auto;">
                <span class="box-lbl">VITALS</span>
                <div style="display:flex; justify-content:space-between; border-bottom:1px solid #333;">
                    <span>CPU</span><span id="cpu">0%</span>
                </div>
                <div style="display:flex; justify-content:space-between; border-bottom:1px solid #333;">
                    <span>TEMP</span><span id="temp">0C</span>
                </div>
                <div style="display:flex; justify-content:space-between;">
                    <span>RSSI</span><span id="rssi">0</span>
                </div>
            </div>
        </div>

        <!-- BOTTOM -->
        <div class="gallery" id="gallery"></div>
    </div>

    <script>
        function update(d) {
            document.getElementById('status').innerText = d.status;
            if(d.accel) ['x','y','z'].forEach(k => document.getElementById('a'+k).innerText = d.accel[k].toFixed(1));
            if(d.gyro) ['x','y','z'].forEach(k => document.getElementById('g'+k).innerText = d.gyro[k].toFixed(1));
            if(d.mag) ['x','y','z'].forEach(k => document.getElementById('m'+k).innerText = d.mag[k].toFixed(0));
            if(d.pos_offset) ['x','y','z'].forEach(k => document.getElementById('off-'+k).innerText = d.pos_offset[k].toFixed(2));
            if(d.cpu_load) document.getElementById('cpu').innerText = d.cpu_load + "%";
            if(d.cpu_temp) document.getElementById('temp').innerText = d.cpu_temp.toFixed(1) + "C";
            if(d.rssi) document.getElementById('rssi').innerText = d.rssi;
            
            const ts = document.getElementById('train-status');
            if (d.calibrating) {
                ts.innerText = "CALIBRATING..."; 
                ts.style.color = "yellow";
            } else if (d.tracking_active) {
                ts.innerText = "TRACKING ACTIVE";
                ts.style.color = "#00ff41";
            } else {
                ts.innerText = "IDLE";
                ts.style.color = "#888";
            }
        }

        async function track(action) {
            await fetch('/api/track', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({action})});
        }
        
        async function snap() {
            await fetch('/api/capture', {method:'POST'});
            loadGal();
        }

        async function loadGal() {
            let res = await fetch('/api/captures');
            let files = await res.json();
            let g = document.getElementById('gallery');
            g.innerHTML = "";
            files.forEach(f => {
                let i = document.createElement('img');
                i.src = "/captures/"+f;
                i.className = "thumb";
                i.onclick = () => window.open(i.src);
                g.appendChild(i);
            });
        }

        setInterval(async () => { try { update(await (await fetch('/api/telemetry')).json()); } catch {} }, 100);
        loadGal();
    </script>
</body>
</html>
